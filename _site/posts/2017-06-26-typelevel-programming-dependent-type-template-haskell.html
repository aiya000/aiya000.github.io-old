<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>あいや☆ぱぶりっしゅぶろぐ！ - 型レベルハンバーガーについての報告</title>
        <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/highlight.css" />
        <!-- bootstrap requires jquery -->
        <script type="text/javascript" src="../js/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="../js/bootstrap.min.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default">
            <div class="navbar-header">
                <a class="navbar-brand" href="../">あいや☆ぱぶりっしゅぶろぐ！</a>
            </div>
            <ul class="nav navbar-nav">
                <li><a href="../">Home</a></li>
                <li><a href="../about.html">About</a></li>
                <li><a href="../profile.html">Profile</a></li>
                <li><a href="../products.html">Products</a></li>
                <li><a href="../archive.html">Archive</a></li>
            </ul>
        </nav>

        <div id="content">
            <h4>型レベルハンバーガーについての報告</h4>
            <link rel="stylesheet" type="text/css" href="../css/post.css" />

<div class="info">
    Posted on 2017/06/26 <br />
    

    Tags:
    
        [<a href="../tags/Haskell.html">Haskell</a>]
    

    <ul class="bookmarkers">
        <li> <!-- See https://about.twitter.com/ja/resources/buttons -->
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="public_ai000ya" data-size="small">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        </li>

        <li> <!-- See http://b.hatena.ne.jp/guide/bbutton -->
            <a href="http://b.hatena.ne.jp/entry/aiya000.github.io/posts/2017-06-26-typelevel-programming-dependent-type-template-haskell.html" class="hatena-bookmark-button" data-hatena-bookmark-title="型レベルハンバーガーについての報告 - あいや☆ぱぶりっしゅぶろぐ！" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
            <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </li>

        <li> <!-- See https://developers.facebook.com/docs/plugins/like-button?locale=ja_JP#configurator -->
            <div class="fb-like" data-href="https://aiya000.github.io/posts/2017-06-26-typelevel-programming-dependent-type-template-haskell.html" data-layout="button_count" data-action="like" data-size="small" data-show-faces="false" data-share="true"></div>
        </li>

        <li> <!-- See https://getpocket.com/publisher/button -->
            <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="ja"></a>
            <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
        </li>
    </ul>
</div>

<hr />

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<ul>
<li>index
<ul>
<li><a href="#%E3%81%93%E3%82%8C%E3%81%AF%E7%A7%81%E7%9A%84%E3%81%AA%E8%BF%91%E6%B3%81%E5%A0%B1%E5%91%8A%E3%81%A7%E3%81%99">これは私的な近況報告です</a></li>
<li><a href="#%E8%A7%A3%E8%AA%AC">解説</a>
<ul>
<li><a href="#%E5%9E%8B%E3%83%AC%E3%83%99%E3%83%AB%E3%83%8F%E3%83%B3%E3%83%90%E3%83%BC%E3%82%AC%E3%83%BC%E3%81%AE%E7%9B%AE%E7%9A%84%E4%B8%BB%E9%A1%8C">型レベルハンバーガーの目的、主題</a></li>
<li><a href="#%E5%9E%8B%E3%83%AC%E3%83%99%E3%83%AB%E3%83%8F%E3%83%B3%E3%83%90%E3%83%BC%E3%82%AC%E3%83%BC%E3%81%AE%E8%A6%8B%E3%81%A9%E3%81%93%E3%82%8D">型レベルハンバーガーの見どころ</a></li>
<li><a href="#%E5%9E%8B%E3%83%AC%E3%83%99%E3%83%AB%E3%83%8F%E3%83%B3%E3%83%90%E3%83%BC%E3%82%AC%E3%83%BC%E3%81%B8%E3%81%AEtopping%E3%81%AE%E8%BF%BD%E5%8A%A0">型レベルハンバーガーへのToppingの追加</a></li>
<li><a href="#th.hs">型レベルプログラミングを解決するためにTemplateHaskellを使うのは1回 回った感がある（TH.hsについて）</a></li>
<li><a href="#%E5%80%A4%E3%83%AC%E3%83%99%E3%83%AB%E3%83%8F%E3%83%B3%E3%83%90%E3%83%BC%E3%82%AC%E3%83%BC">値レベルハンバーガー</a></li>
<li><a href="#%E3%81%A8%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%A7">ということで</a></li>
</ul></li>
<li><a href="#%E5%85%83%E3%83%8D%E3%82%BF">元ネタ</a></li>
<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
<li><a href="#special-thanks-">Special Thanks !</a></li>
</ul></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h1 id="これは私的な近況報告です">これは私的な近況報告です</h1>
<p>　ここ4日くらいは型レベルプログラミングの体験をしていました！<br />
その成果物である、型レベルハンバーガーはHamburger.hs及びHamburger/TH.hsから成ります。</p>
<!-- 出力結果 {{{ -->
<p>出力結果</p>
<pre class="console"><code>SHamburger (Space Space Space Space)
SHamburger (Cheese Space Space Space)
SHamburger (Cheese Tomato Space Space)
SHamburger (Cheese Tomato Meet Space)
SHamburger (Cheese Tomato Meet Ushi)</code></pre>
<!-- }}} -->
<!-- Hamburger.hs {{{ -->
<ul>
<li><a href="https://github.com/aiya000/learning-Haskell/blob/d4d29ad26673e828bc0b0358d1cde42c295eb50b/Language/Haskell/Extension/Room/Hamburger.hs">Hamburger.hs</a></li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE DataKinds #-}</span>
<span class="ot">{-# LANGUAGE FlexibleInstances #-}</span>
<span class="ot">{-# LANGUAGE GADTs #-}</span>
<span class="ot">{-# LANGUAGE TemplateHaskell #-}</span>
<span class="ot">{-# LANGUAGE TypeFamilies #-}</span>

<span class="kw">module</span> <span class="dt">Hamberger</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Hamburger.TH</span> (defineInstances)

<span class="co">-- | A kind of the topping, and types.</span>
<span class="kw">data</span> <span class="dt">Topping</span> <span class="fu">=</span> <span class="dt">Space</span> <span class="co">-- ^ Mean a space, it can be inserted some @Topping@</span>
             <span class="fu">|</span> <span class="dt">Cheese</span> <span class="fu">|</span> <span class="dt">Tomato</span> <span class="fu">|</span> <span class="dt">Meet</span> <span class="fu">|</span> <span class="dt">Ushi</span>

<span class="co">-- |</span>
<span class="co">-- A type level function</span>
<span class="co">-- that maps @HamburgerT@ and @Topping@ to @HamburgerT@.</span>
<span class="co">--</span>
<span class="co">-- If @HamburgerC a b c d@ :: @HamburgerT@ of the domain has no space, or @Fail@ is specified to the domain,</span>
<span class="co">-- return @Fail@ type.</span>
<span class="kw">type</span> family <span class="dt">AddTopping</span> (<span class="ot">h ::</span> <span class="dt">HamburgerT</span>) (<span class="ot">t ::</span> <span class="dt">Topping</span>)<span class="ot"> ::</span> <span class="dt">HamburgerT</span> <span class="kw">where</span>
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> <span class="dt">Space</span> b c d) t <span class="fu">=</span> <span class="dt">HamburgerC</span> t b c d
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> a <span class="dt">Space</span> c d) t <span class="fu">=</span> <span class="dt">HamburgerC</span> a t c d
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> a b <span class="dt">Space</span> d) t <span class="fu">=</span> <span class="dt">HamburgerC</span> a b t d
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> a b c <span class="dt">Space</span>) t <span class="fu">=</span> <span class="dt">HamburgerC</span> a b c t
  <span class="dt">AddTopping</span> _ _ <span class="fu">=</span> <span class="dt">Fail</span>

<span class="co">-- | A kind of the abstract hamburger</span>
<span class="kw">data</span> <span class="dt">HamburgerT</span> <span class="fu">=</span> <span class="dt">HamburgerC</span> <span class="dt">Topping</span> <span class="dt">Topping</span> <span class="dt">Topping</span> <span class="dt">Topping</span> <span class="co">-- ^ A type constructor of the abstract hamburger</span>
                <span class="fu">|</span> <span class="dt">Fail</span> <span class="co">-- ^ Mean a fail of a mapping of @AddTopping@</span>


<span class="co">{- The dependent type -}</span>

<span class="co">-- |</span>
<span class="co">-- A concrete of the hamburger</span>
<span class="co">-- (A type constructor for a type of @HamburgerT@ kind).</span>
<span class="kw">data</span> <span class="dt">SHamburger</span> (<span class="ot">h ::</span> <span class="dt">HamburgerT</span>) <span class="kw">where</span>
  <span class="dt">Concrete</span><span class="ot"> ::</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">SHamburger</span> (<span class="dt">HamburgerC</span> a b c<span class="ot"> d ::</span> <span class="dt">HamburgerT</span>)

<span class="co">-- | A singleton type for @Topping@ kind.</span>
<span class="kw">data</span> <span class="dt">STopping</span> <span class="fu">=</span> <span class="dt">SSpace</span> <span class="fu">|</span> <span class="dt">SCheese</span> <span class="fu">|</span> <span class="dt">STomato</span> <span class="fu">|</span> <span class="dt">SMeet</span> <span class="fu">|</span> <span class="dt">SUshi</span>
  <span class="kw">deriving</span> (<span class="dt">Show</span>)

<span class="co">-- | Represent the simply dependent type</span>
<span class="kw">class</span> <span class="dt">Singleton</span> (<span class="ot">h ::</span> <span class="dt">HamburgerT</span>) <span class="kw">where</span>
<span class="ot">  sing ::</span> <span class="dt">SHamburger</span> h


<span class="co">-- Define any instances for 126 patterns !</span>
defineInstances


<span class="kw">type</span> <span class="dt">BasicHamburgerC</span> <span class="fu">=</span> <span class="dt">HamburgerC</span> <span class="dt">Space</span> <span class="dt">Space</span> <span class="dt">Space</span> <span class="dt">Space</span>

<span class="kw">type</span> <span class="dt">HamburgerC1</span> <span class="fu">=</span> <span class="dt">AddTopping</span> <span class="dt">BasicHamburgerC</span> <span class="dt">Cheese</span> <span class="co">-- these kind is @HamburgerT@</span>
<span class="kw">type</span> <span class="dt">HamburgerC2</span> <span class="fu">=</span> <span class="dt">AddTopping</span> <span class="dt">HamburgerC1</span> <span class="dt">Tomato</span>
<span class="kw">type</span> <span class="dt">HamburgerC3</span> <span class="fu">=</span> <span class="dt">AddTopping</span> <span class="dt">HamburgerC2</span> <span class="dt">Meet</span>
<span class="kw">type</span> <span class="dt">HamburgerC4</span> <span class="fu">=</span> <span class="dt">AddTopping</span> <span class="dt">HamburgerC3</span> <span class="dt">Ushi</span>
<span class="kw">type</span> <span class="dt">HamburgerC5</span> <span class="fu">=</span> <span class="dt">AddTopping</span> <span class="dt">HamburgerC4</span> <span class="dt">Ushi</span> <span class="co">-- = Fail</span>

x0 <span class="fu">=</span><span class="ot"> sing ::</span> <span class="dt">SHamburger</span> <span class="dt">BasicHamburgerC</span>
x1 <span class="fu">=</span><span class="ot"> sing ::</span> <span class="dt">SHamburger</span> <span class="dt">HamburgerC1</span>
x2 <span class="fu">=</span><span class="ot"> sing ::</span> <span class="dt">SHamburger</span> <span class="dt">HamburgerC2</span>
x3 <span class="fu">=</span><span class="ot"> sing ::</span> <span class="dt">SHamburger</span> <span class="dt">HamburgerC3</span>
x4 <span class="fu">=</span><span class="ot"> sing ::</span> <span class="dt">SHamburger</span> <span class="dt">HamburgerC4</span>
<span class="co">--x5 = sing :: SHamburger HamburgerC5 -- This is the compile error because Refl is not a Fail's value</span>


<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  print x0
  print x1
  print x2
  print x3
  print x4</code></pre></div>
<!-- }}} -->
<!-- Hamburger/TH.hs {{{ -->
<ul>
<li><a href="https://github.com/aiya000/learning-Haskell/blob/d4d29ad26673e828bc0b0358d1cde42c295eb50b/Language/Haskell/Extension/Room/Hamburger/TH.hs">Hamburger/TH.hs</a></li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span>

<span class="kw">module</span> <span class="dt">Hamburger.TH</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Language.Haskell.TH</span> (<span class="dt">Type</span>(..), <span class="dt">Name</span>, mkName, <span class="dt">Exp</span>(..), <span class="dt">DecsQ</span>, <span class="dt">Dec</span>(..), <span class="dt">Clause</span>(..), <span class="dt">Pat</span>(..), <span class="dt">Body</span>(..), <span class="dt">Lit</span>(..))

<span class="kw">type</span> <span class="dt">TypeName</span> <span class="fu">=</span> <span class="dt">String</span>

<span class="kw">type</span> <span class="dt">Topping4</span> <span class="fu">=</span> (<span class="dt">TypeName</span>, <span class="dt">TypeName</span>, <span class="dt">TypeName</span>, <span class="dt">TypeName</span>)


<span class="ot">topping4s ::</span> [<span class="dt">Topping4</span>]
topping4s <span class="fu">=</span> [(w, x, y, z) <span class="fu">|</span> w <span class="ot">&lt;-</span> toppings, x <span class="ot">&lt;-</span> toppings, y <span class="ot">&lt;-</span> toppings, z <span class="ot">&lt;-</span> toppings]
  <span class="kw">where</span>
<span class="ot">    toppings ::</span> [<span class="dt">TypeName</span>]
    toppings <span class="fu">=</span> [<span class="st">&quot;Space&quot;</span>, <span class="st">&quot;Cheese&quot;</span>, <span class="st">&quot;Tomato&quot;</span>, <span class="st">&quot;Meet&quot;</span>, <span class="st">&quot;Ushi&quot;</span>]

<span class="co">-- | Make a AST of @Type@ is like &quot;(HamburgerC Space Cheese Tomato Meet)&quot;</span>
<span class="ot">hamburgerC ::</span> <span class="dt">Topping4</span> <span class="ot">-&gt;</span> <span class="dt">Type</span>
hamburgerC (w, x, y, z) <span class="fu">=</span> <span class="dt">ParensT</span> (<span class="dt">ConT</span> (mkName <span class="st">&quot;HamburgerC&quot;</span>) 
                            <span class="ot">`AppT`</span> <span class="dt">ConT</span> (mkName w)
                            <span class="ot">`AppT`</span> <span class="dt">ConT</span> (mkName x)
                            <span class="ot">`AppT`</span> <span class="dt">ConT</span> (mkName y)
                            <span class="ot">`AppT`</span> <span class="dt">ConT</span> (mkName z))

<span class="co">-- |</span>
<span class="co">-- Make a AST of @Exp@ is like &quot;Concrete SSpace SCheese STomato SMeet&quot;</span>
<span class="co">-- (@Topping4@ elements are added &quot;S&quot; prefix for @STopping@).</span>
<span class="ot">concrete ::</span> <span class="dt">Topping4</span> <span class="ot">-&gt;</span> <span class="dt">Exp</span>
concrete (w, x, y, z) <span class="fu">=</span> <span class="dt">ConE</span> (mkName <span class="st">&quot;Concrete&quot;</span>)
                 <span class="ot">`AppE`</span> <span class="dt">ConE</span> (mkName <span class="fu">$</span> <span class="st">&quot;S&quot;</span> <span class="fu">++</span> w)
                 <span class="ot">`AppE`</span> <span class="dt">ConE</span> (mkName <span class="fu">$</span> <span class="st">&quot;S&quot;</span> <span class="fu">++</span> x)
                 <span class="ot">`AppE`</span> <span class="dt">ConE</span> (mkName <span class="fu">$</span> <span class="st">&quot;S&quot;</span> <span class="fu">++</span> y)
                 <span class="ot">`AppE`</span> <span class="dt">ConE</span> (mkName <span class="fu">$</span> <span class="st">&quot;S&quot;</span> <span class="fu">++</span> z)


<span class="co">-- | Define @Singleton@ instances and @Show@ instances for any pattern of @topping4@</span>
<span class="ot">defineInstances ::</span> <span class="dt">DecsQ</span>
defineInstances <span class="fu">=</span> <span class="kw">do</span>
  <span class="kw">let</span> singletonInstances <span class="fu">=</span> map defineSingletonInstance topping4s
      showInstances      <span class="fu">=</span> map defineShowInstance topping4s
  return <span class="fu">$</span> singletonInstances <span class="fu">++</span> showInstances
  <span class="kw">where</span>
<span class="ot">    defineSingletonInstance ::</span> <span class="dt">Topping4</span> <span class="ot">-&gt;</span> <span class="dt">Dec</span>
    defineSingletonInstance t4<span class="fu">@</span>(w, x, y, z) <span class="fu">=</span>
      <span class="dt">InstanceD</span> <span class="dt">Nothing</span> []
        (<span class="dt">ConT</span> (mkName <span class="st">&quot;Singleton&quot;</span>) <span class="ot">`AppT`</span> hamburgerC t4)
        [
          <span class="dt">FunD</span> (mkName <span class="st">&quot;sing&quot;</span>) [<span class="dt">Clause</span> [] (<span class="dt">NormalB</span> <span class="fu">$</span> concrete t4) []]
        ]

<span class="ot">    defineShowInstance ::</span> <span class="dt">Topping4</span> <span class="ot">-&gt;</span> <span class="dt">Dec</span>
    defineShowInstance t4<span class="fu">@</span>(w, x, y, z) <span class="fu">=</span>
      <span class="dt">InstanceD</span> <span class="dt">Nothing</span> []
        (<span class="dt">ConT</span> (mkName <span class="st">&quot;Show&quot;</span>) <span class="ot">`AppT`</span> <span class="dt">ParensT</span> (<span class="dt">ConT</span> (mkName <span class="st">&quot;SHamburger&quot;</span>) <span class="ot">`AppT`</span> hamburgerC t4))
        [
          <span class="dt">FunD</span> (mkName <span class="st">&quot;show&quot;</span>) [<span class="dt">Clause</span> [<span class="dt">WildP</span>] (<span class="dt">NormalB</span> <span class="fu">$</span>
              (<span class="dt">LitE</span> <span class="fu">.</span> <span class="dt">StringL</span> <span class="fu">$</span> <span class="st">&quot;SHamburger (&quot;</span> <span class="fu">++</span> w <span class="fu">++</span> <span class="st">&quot; &quot;</span> <span class="fu">++</span> x <span class="fu">++</span> <span class="st">&quot; &quot;</span> <span class="fu">++</span> y <span class="fu">++</span> <span class="st">&quot; &quot;</span> <span class="fu">++</span> z <span class="fu">++</span> <span class="st">&quot;)&quot;</span>)
          ) []]
        ]</code></pre></div>
<!-- }}} -->
<h1 id="解説">解説</h1>
<h2 id="型レベルハンバーガーの目的主題">型レベルハンバーガーの目的、主題</h2>
<p>　型レベルハンバーガーは</p>
<ol style="list-style-type: decimal">
<li>5つ以上のトッピングを追加されると、例外ではなくコンパイルエラーで失敗を報告します</li>
<li>失敗していない有効なハンバーガーは、値として取得できます</li>
</ol>
<p>というのが目的（主題）です。 （2つ目のやつは後付け）</p>
<p>詳細にはこんな感じ。</p>
<ol style="list-style-type: decimal">
<li>5つ以上の<code>Topping</code>を追加されると（<code>x5</code>を介して）コンパイルエラーになります</li>
<li><code>Topping</code>の追加はTypeFamiliesの型関数<code>AddTopping</code>によって追加されます</li>
<li><code>Topping</code>の追加は種<code>HamburgerT</code>の型<code>Hamburger a b c d</code>に対して行われます
<ul>
<li><code>type family AddTopping (h :: HamburgerT) (t :: Topping) :: HamburgerT</code></li>
<li>（擬似的には<code>HamburgerT -&gt; Topping -&gt; HamburgerT</code>）</li>
</ul></li>
<li>種<code>HamburgerT</code>を持つ型のうち有効なもの（つまり<code>Fail</code>以外）は値レベルに降格できます
<ul>
<li>備考: 依存型って、値から型への昇格を扱うだけのものじゃなかったんだね</li>
</ul></li>
</ol>
<h2 id="型レベルハンバーガーの見どころ">型レベルハンバーガーの見どころ</h2>
<p>　これの見どころ（こだわりどころ）は、Hamburger.hsのトップレベルにある<code>x5</code>をコンパイルしようとすると、コンパイルエラーになるところです。<br />
それは、<code>x5</code>の型である<code>SHamburger HambergerC5</code>が<code>SHamburger Fail</code>であり （※<a href="../posts/2017-06-24-ghci-type-level-debug.html">:kind!</a>） <code>Fail</code>はHamburger.hsに定義されている型クラス<code>Singleton</code>のインスタンスではないからです。 （<code>sing</code>関数は<code>Singleton</code>の関数）</p>
<p>　以下の型の<code>Singleton</code>インスタンスは</p>
<ul>
<li><code>SHamburger BasicHamburgerC</code></li>
<li><code>SHamburger HamburgerC1</code></li>
<li><code>SHamburger HamburgerC2</code></li>
<li><code>SHamburger HamburgerC3</code></li>
<li><code>SHamburger HamburgerC4</code></li>
</ul>
<p>TemplateHaskellによってHamburger.hsのトップレベルで展開される<code>defineInstances</code>によって定義されます。 <code>defineInstances</code>はTH.hsによって提供されているメタ関数です。</p>
<h2 id="型レベルハンバーガーへのtoppingの追加">型レベルハンバーガーへのToppingの追加</h2>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> family <span class="dt">AddTopping</span> (<span class="ot">h ::</span> <span class="dt">HamburgerT</span>) (<span class="ot">t ::</span> <span class="dt">Topping</span>)<span class="ot"> ::</span> <span class="dt">HamburgerT</span> <span class="kw">where</span>
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> <span class="dt">Space</span> b c d) t <span class="fu">=</span> <span class="dt">HamburgerC</span> t b c d
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> a <span class="dt">Space</span> c d) t <span class="fu">=</span> <span class="dt">HamburgerC</span> a t c d
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> a b <span class="dt">Space</span> d) t <span class="fu">=</span> <span class="dt">HamburgerC</span> a b t d
  <span class="dt">AddTopping</span> (<span class="dt">HamburgerC</span> a b c <span class="dt">Space</span>) t <span class="fu">=</span> <span class="dt">HamburgerC</span> a b c t
  <span class="dt">AddTopping</span> _ _ <span class="fu">=</span> <span class="dt">Fail</span></code></pre></div>
<p>　このパターンそのまんまですね、TypeFamiliesです。</p>
<h2 id="型レベルプログラミングを解決するためにtemplatehaskellを使うのは1回-回った感があるth.hsについて">型レベルプログラミングを解決するためにTemplateHaskellを使うのは1回 回った感がある（TH.hsについて）</h2>
<p>　TH.hsにある<code>defineInstances</code>は<code>SHamburger (HamburgerC a b c d :: HamburgerT)</code>の形をした126個の型の<code>Singleton</code>インスタンスを生成します。 （つまり<code>SHamburger (h :: HamburgerT)</code>のうち<code>Fail</code>以外に対する）</p>
<p>　<code>Singleton</code>は依存型（もどき？）を扱うためのものです。</p>
<p>　<a href="http://konn-san.com/prog/2013-advent-calendar.html">参考にしたページ</a>では自然数の帰納法を使ってインスタンスを実装してましたが、 依存型を使うことを考える前に考えた構造が全然帰納的でなかったので、TemplateHaskellを使って力技で解決しました。 （誰かうまい方法を教えてください！）</p>
<h2 id="値レベルハンバーガー">値レベルハンバーガー</h2>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">SHamburger</span> (<span class="ot">h ::</span> <span class="dt">HamburgerT</span>) <span class="kw">where</span>
  <span class="dt">Concrete</span><span class="ot"> ::</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">STopping</span> <span class="ot">-&gt;</span> <span class="dt">SHamburger</span> (<span class="dt">HamburgerC</span> a b c<span class="ot"> d ::</span> <span class="dt">HamburgerT</span>)

<span class="kw">data</span> <span class="dt">STopping</span> <span class="fu">=</span> <span class="dt">SSpace</span> <span class="fu">|</span> <span class="dt">SCheese</span> <span class="fu">|</span> <span class="dt">STomato</span> <span class="fu">|</span> <span class="dt">SMeet</span> <span class="fu">|</span> <span class="dt">SUshi</span>
  <span class="kw">deriving</span> (<span class="dt">Show</span>)</code></pre></div>
<p>　各<code>Singleton</code>インスタンス実装は<code>defineInstances</code>が行うので具体的なコードはありませんが、このようなものになります。</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span> <span class="dt">Singleton</span> (<span class="dt">HamburgerC</span> <span class="dt">Cheese</span> <span class="dt">Ushi</span> <span class="dt">Meet</span> <span class="dt">Space</span>) <span class="kw">where</span>
  sing <span class="fu">=</span> <span class="dt">Concrete</span> <span class="dt">SCheese</span> <span class="dt">SUshi</span> <span class="dt">SMeet</span> <span class="dt">SSpace</span></code></pre></div>
<p>　Haskellでは依存型は実際には使えないらしいので、インスタンスになる型と<code>sing</code>（の具体値）はこのような一対一対応になります。</p>
<pre><code>型レベル: HamburgerC Cheese Ushi Meet Space
値レベル: Concrete SCheese SUshi SMeet SSpace</code></pre>
<p><code>HamburgerC</code>に<code>Cheese Ushi Meet Space</code>が指定されれば、その値は<code>Concrete</code>と<code>SCheese SUshi SMeet SSpace</code>に限り<br />
その逆もまた同じく限る感じです。</p>
<p>一意的ってことですね。</p>
<h2 id="ということで">ということで</h2>
<p>　進捗報告はこんな感じでした 🐕</p>
<h1 id="元ネタ">元ネタ</h1>
<blockquote class="twitter-tweet" data-lang="ja">
<p lang="ja" dir="ltr">
@ U科各位<br><br>Java課題ソースコード<a href="https://t.co/NOUtZAxB44">https://t.co/NOUtZAxB44</a>
</p>
— 焼きそばメロンパン@🍣 (<span class="citation">@ice_arr</span>) <a href="https://twitter.com/ice_arr/status/876673209575251968">2017年6月19日</a>
</blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<h1 id="参考">参考</h1>
<ul>
<li><a href="http://konn-san.com/prog/2013-advent-calendar.html">定理証明系 Haskell - konn-san.com</a></li>
</ul>
<h1 id="special-thanks">Special Thanks !</h1>
<ul>
<li><a href="https://github.com/aiya000/learning-Haskell/pull/1">Type Level Humberger by Hexirp · Pull Request #1 · aiya000/learning-Haskell · GitHub</a>
<ul>
<li>and Haskell-jp members !</li>
</ul></li>
<li>僕がTemplateHaskellによって何個のインスタンスを生成したのかをRubyインタプリタで調べてくれたぶらっきぃくん</li>
</ul>

<hr />
<hr />

<p class="about-pr">
この記事はこちらから修正リクエストを送ることができます。 <br />
<a href="https://github.com/aiya000/aiya000.github.io/blob/src/posts/2017-06-26-typelevel-programming-dependent-type-template-haskell.md">型レベルハンバーガーについての報告 - github</a> <br />
ゴミ箱ボタンの左にある、鉛筆ボタンを押してね！
</p>

<script src="../js/facebook-sdk-2.8.js"></script>

        </div>

        <div id="footer">
            (*^o^) { This blog powerd by Haskell <a href="http://jaspervdj.be/hakyll">Hakyll</a> <br />
            and Uses <a href="http://nkmr6194.github.io/Umi/">Umi</a>
        </div>
    </body>
</html>
