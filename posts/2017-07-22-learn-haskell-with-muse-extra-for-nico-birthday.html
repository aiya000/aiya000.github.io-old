<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>大銀河宇宙No.1-Haskeller-にこにー - にこ、希と一緒に学ぶHaskell（番外）「extensible-effectsの基本作用」 +絵里</title>
        <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/highlight.css" />
        <!-- bootstrap requires jquery -->
        <script type="text/javascript" src="../js/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="../js/bootstrap.min.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default">
            <div class="navbar-header">
                <a class="navbar-brand" href="../">大銀河宇宙No.1-Haskeller-にこにー</a>
            </div>
            <ul class="nav navbar-nav">
                <li><a href="../">Home</a></li>
                <li><a href="../about.html">About</a></li>
                <li><a href="../profile.html">Profile</a></li>
                <li><a href="../products.html">Products</a></li>
                <li><a href="../archive.html">Archive</a></li>
            </ul>
        </nav>

        <div id="content">
            <h4>にこ、希と一緒に学ぶHaskell（番外）「extensible-effectsの基本作用」 +絵里</h4>
            <link rel="stylesheet" type="text/css" href="../css/post.css" />

<div class="info">
    Posted on 2017/07/22 <br />
    

    Tags:
    
        [<a href="../tags/ラブライブ！で学ぶ.html">ラブライブ！で学ぶ</a>]
    
        [<a href="../tags/にこ、希と一緒に学ぶHaskell.html">にこ、希と一緒に学ぶHaskell</a>]
    
        [<a href="../tags/Haskell.html">Haskell</a>]
    

    <ul class="bookmarkers">
        <li> <!-- See https://about.twitter.com/ja/resources/buttons -->
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="public_ai000ya" data-size="small">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        </li>

        <li> <!-- See http://b.hatena.ne.jp/guide/bbutton -->
            <a href="http://b.hatena.ne.jp/entry/aiya000.github.io/posts/2017-07-22-learn-haskell-with-muse-extra-for-nico-birthday.html" class="hatena-bookmark-button" data-hatena-bookmark-title="にこ、希と一緒に学ぶHaskell（番外）「extensible-effectsの基本作用」 +絵里 - あいや☆ぱぶりっしゅぶろぐ！" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
            <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
        </li>

        <li> <!-- See https://developers.facebook.com/docs/plugins/like-button?locale=ja_JP#configurator -->
            <div class="fb-like" data-href="https://aiya000.github.io/posts/2017-07-22-learn-haskell-with-muse-extra-for-nico-birthday.html" data-layout="button_count" data-action="like" data-size="small" data-show-faces="false" data-share="true"></div>
        </li>

        <li> <!-- See https://getpocket.com/publisher/button -->
            <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="ja"></a>
            <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
        </li>
    </ul>
</div>

<hr />

<p>せーのっ</p>
<p>希・絵里「にこ（っち）、ハッピーバースデー！♡」</p>
<p>🎉 ﾊﾟﾊﾟｰﾝ!!</p>
<p>にこ「わ……」</p>
<hr />
<ul>
<li><a href="./2017-05-06-learn-haskell-with-muse.html">本編その1（ことり、穂乃果と一緒に学ぶHaskell（入門）その1「代数的データ型の定義」）</a></li>
<li><a href="./2017-05-27-learn-haskell-with-muse-extra.html">前回 - にこ、希と一緒に学ぶHaskell（番外）「型クラスの定義と実装（Extra）」</a></li>
<li><a href="https://github.com/aiya000/aiya000.github.io/search?utf8=%E2%9C%93&amp;q=%22Haskell%2FMuse%3A%22&amp;type=Commits">更新履歴 - μ’sと一緒に学ぶHaskell</a></li>
<li><a href="../tags/にこ、希と一緒に学ぶHaskell.html">記事一覧 - にこ、希と一緒に学ぶHaskell（番外）</a></li>
</ul>
<hr />
<h1 id="月22日矢澤にこ誕生日">7月22日（矢澤にこ誕生日）</h1>
<p>希「いや〜〜、うちなんかさっきまでにこっちの誕生日知らんかったわ〜〜」<br />
にこ「な……なによもう」<br />
希「なーんて、冗談やでw　ちゃんと今日はエリチも呼んで、お祝いがてらのHaskell番外編や」</p>
<p>絵里「ハロー。　ノーエリー・ノーライフ！」ｷﾗｯ</p>
<p>にこ「誕生日なのに、すごく急に駆り出されたかと思ったら、そういうことだったのね。 　Haskellに関することじゃなかったらキレてたかもしれないけど、それならいいわ」</p>
<hr />
<p>にこ「ところで絵里は、Haskellのこと知ってるのかしら？」<br />
絵里「基本知識を備えている程度ね。　<code>Maybe</code>, <code>Either</code>, <code>Monad</code>。　ハラショー！」<br />
にこ「なるほど、だいたいわかったわ」</p>
<p>希「今日はにこっちの誕生日やし、うち このために、にこっちが好きそうな構造を勉強したんよ」<br />
希（エリチはちょっと置いてきぼりにしちゃうかもしれんけど……）</p>
<p>にこ「！　なにかしら？」</p>
<p>希「その名も……effect-systemや！」ﾄﾞﾄﾞｰﾝ<br />
にこ「！」</p>
<h1 id="extensible-effects">extensible-effects</h1>
<p>希「といっても今回うちが使ったんは、その実装の1つである<code>extensible-effects</code>っちゅうライブラリやん。 　正直なところeffect-systemが何かは……論文読んだりしたことないしわからんわ」</p>
<p>希（ちなみに、うち知らんかったんやけど、<code>freer</code>っていう、もうちょっといいらしいeffect-system実装もあるらしいで〜）</p>
<ul>
<li><a href="https://hackage.haskell.org/package/freer">freer: Implementation of the Freer Monad - hackage</a></li>
</ul>
<p>絵里「私も、なにやら『<code>Monad</code>スタックを置き換える』やら……って聞いたことあるわ。 　<code>Monad</code>スタックも正直わからないけど……」<br />
にこ「<code>Monad</code>スタックの詳細についてはまた今度改めて、回を開きましょうか。 　私も『<code>MonadTrans</code>の<code>lift</code>よりも高速に動く』って聞いたことがあるわ」<br />
希「パフォーマンスうんぬんは測定してなくて正直わからないんやけど、確かにエリチが言ってた−−<code>Monad</code>スタックを置き換える−−方のやつは確認したで〜」</p>
<h1 id="長くなるし基本はこっちを読んでくれな">長くなるし、基本はこっちを読んでくれな〜</h1>
<p>希「基本的なことはこっちに書いておいたので、読んでくれな〜」</p>
<ul>
<li><a href="./2017-07-07-eff-experience.html">extensible-effects入門者がextensible-effectsをやってみた軌跡 - この世界線では私が希ちゃんの代わりに代筆しております</a></li>
</ul>
<p>希「まあ基本は<code>Member</code>, <code>SetMember</code>, <code>Lift</code>でアレアレコレコレエリエリチカチカする感じやね」<br />
にこ「へー、なるほど。 　アレアレコレコレエリエリチカチカするのね。 　面白いわね！」<br />
絵里「なるほど、すごいわね！」（←わかってない）</p>
<h1 id="monadスタックの大体としての作用の合成">Monadスタックの大体としての作用の合成</h1>
<p>希「てな感じに、<code>State Foo</code>, <code>Reader Bar</code>のようなモノを<code>Member</code>または<code>SetMember</code>で指定するわけやね」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">context ::</span> (<span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Foo</span>) r, <span class="dt">Member</span> (<span class="dt">Reader</span> <span class="dt">Bar</span>) r) <span class="ot">=&gt;</span> <span class="dt">Eff</span> r a</code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">impureContext ::</span> ( <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Foo</span>) r, <span class="dt">Member</span> (<span class="dt">Reader</span> <span class="dt">Bar</span>) r
                 , <span class="dt">SetMember</span> <span class="dt">Lift</span> (<span class="dt">Lift</span> <span class="dt">IO</span>)
                 ) <span class="ot">=&gt;</span> <span class="dt">Eff</span> r a</code></pre></div>
<p>希「これを見ても『<code>Monad</code>スタックを代替する』っていうのはよくわからへんと思う。　<code>MonadTrans</code>使っても同じこと書けるしな」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">context' ::</span> (<span class="dt">MonadState</span> <span class="dt">Foo</span> m, <span class="dt">MonadReader</span> <span class="dt">Bar</span> m) <span class="ot">=&gt;</span> m a</code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">impureContext' ::</span> ( <span class="dt">MonadState</span> <span class="dt">Foo</span> m, <span class="dt">MonadReader</span> <span class="dt">Bar</span> m
                  , <span class="dt">MonadIO</span> m
                  ) <span class="ot">=&gt;</span> m a</code></pre></div>
<p>絵里「すごく見た目が同じね」<br />
希「そう、ここまでは同じなんよ。　でも、型を具体化した時にその特徴が表れるんや！」</p>
<h2 id="作用の合成やん">作用の合成やん</h2>
<p>希「さっきの<code>impureContext</code>の型を具体してみるで〜」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">impureContext ::</span> <span class="dt">Eff</span> (<span class="dt">State</span> <span class="dt">Foo</span> <span class="fu">:&gt;</span> <span class="dt">Reader</span> <span class="dt">Bar</span> <span class="fu">:&gt;</span> <span class="dt">Lift</span> <span class="dt">IO</span> <span class="fu">:&gt;</span> <span class="dt">Void</span>) a</code></pre></div>
<p>希「具体化する時は、右端に<code>Void</code>を忘れんようにね」</p>
<p>にこ「<code>(:&gt;)</code>って？」</p>
<p>希「GHCの<code>TypeOperators</code>っていう拡張で書けるようになる、いわゆる型演算子やね」<br />
希「まあイメージ的にはこんなデータ型やね。　実際は各関数の型を制御するための幽霊型として<code>EmptyDataDecl</code>を使って定義されてるんやけど」</p>
<p>イメージ</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> a <span class="fu">:&gt;</span> b <span class="fu">=</span> <span class="dt">SumOfType</span> a b</code></pre></div>
<p>にこ「つまりは<code>(:&gt;)</code>は<code>a</code>,<code>b</code>という情報を持つ型……単なる型と型の足し算を表す型って感じかしら」<br />
希「さすがやねにこっち、その通りや」</p>
<p>絵里「なるほど……」（←わかってない）</p>
<p>希「ここでは<code>(:&gt;)</code>の左辺の型及び右辺の型を『作用』って言っていくで〜」</p>
<p>希「そして……これに対して、さっきの<code>impureContext'</code>を具体化するとこんな感じのスタックになるね」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">impureContext' ::</span> <span class="dt">StateT</span> <span class="dt">Foo</span> (<span class="dt">ReaderT</span> <span class="dt">Bar</span> <span class="dt">IO</span>) a</code></pre></div>
<p>希「よりわかりやすい例としては、前者は作用のみを<code>type</code>できるけど、後者は全体が各<code>Monad</code>のスタックを現してるから部分ぶぶんは<code>type</code>できへんね♡」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">LibraryEffect</span> <span class="fu">=</span> <span class="dt">State</span> <span class="dt">Foo</span> <span class="fu">:&gt;</span> <span class="dt">Reader</span> <span class="dt">Bar</span> <span class="fu">:&gt;</span> <span class="dt">Lift</span> <span class="dt">IO</span> <span class="fu">:&gt;</span> <span class="dt">Void</span>
<span class="ot">impureContext ::</span> <span class="dt">Eff</span> <span class="dt">LibraryEffect</span> a</code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">Library</span> a <span class="fu">=</span> <span class="dt">StateT</span> <span class="dt">Foo</span> (<span class="dt">ReaderT</span> <span class="dt">Bar</span> <span class="dt">IO</span>) a
<span class="ot">impureContext' ::</span> <span class="dt">Library</span> a</code></pre></div>
<p>にこ「なるほど、確かにスタックを積んでる感じはしないわね。　<code>LibraryEffect</code>の定義なんて、綺麗なものねー」</p>
<p>希「そうなんよ！　<code>State Foo :&gt; Reader Bar</code>なんて、なんか『合成』って感じがせえへん！？」<br />
にこ「するわね！！」<br />
絵里「そうなるわね！」（←わかってない）</p>
<h1 id="夏色えがおで12run">夏色えがおで1,2,run!</h1>
<p>希「あとは<code>runReader</code>やらで、その合成……幽霊型を除去したりするだけやね♪」<br />
絵里「だけね！」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- Reader e :&gt; rからReader eを引いてrにする</span>
<span class="ot">runReader ::</span> <span class="dt">Typeable</span> e
          <span class="ot">=&gt;</span> <span class="dt">Eff</span> (<span class="dt">Reader</span> e <span class="fu">:&gt;</span> r) w <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> <span class="dt">Eff</span> r w</code></pre></div>
<h1 id="extensible-effectsには怖いこともあってな">extensible-effectsには怖いこともあってな……</h1>
<p>希「まあeffはこんな感じやね！　<code>MonadTrans</code>と比べて楽に書けるって人もいそうやんっ」<br />
にこ「私もさっそく試してみようかしら！」</p>
<p>希「でも少しだけeffには怖いものがあってな……」<br />
にこ「」ｶﾀｶﾀｶﾀｶﾀ型ｶﾀ</p>
<p>希「型を具体化せずに、綺麗な抽象化を保ったままミスをすると……ちょっと面白さんなコンパイルエラーが出るからそこはおおきにな♡」<br />
にこ「ｸﾞｱｱｱｱｱｱｱｱｱ！！」</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span>
<span class="ot">{-# LANGUAGE TypeOperators #-}</span>

<span class="kw">import </span><span class="dt">Control.Eff</span> (<span class="dt">Eff</span>, <span class="dt">Member</span>, (:&gt;))
<span class="kw">import </span><span class="dt">Control.Eff.Exception</span> (<span class="dt">Exc</span>)
<span class="kw">import </span><span class="dt">Control.Eff.Reader.Lazy</span> (<span class="dt">Reader</span>)
<span class="kw">import </span><span class="dt">Control.Eff.State.Lazy</span> (<span class="dt">State</span>)
<span class="kw">import </span><span class="dt">Data.Void</span> (<span class="dt">Void</span>)

<span class="kw">data</span> <span class="dt">Foo</span>
<span class="kw">data</span> <span class="dt">Bar</span>

<span class="ot">context ::</span> (<span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Foo</span>) r, <span class="dt">Member</span> (<span class="dt">Reader</span> <span class="dt">Bar</span>) r, <span class="dt">Member</span> (<span class="dt">Exc</span> <span class="dt">String</span>) r) <span class="ot">=&gt;</span> <span class="dt">Eff</span> r ()
context <span class="fu">=</span> return ()

<span class="ot">realContext ::</span> <span class="dt">Eff</span> (<span class="dt">State</span> <span class="dt">Foo</span> <span class="fu">:&gt;</span> <span class="dt">Reader</span> <span class="dt">Bar</span> <span class="fu">:&gt;</span> <span class="dt">Void</span>) ()
realContext <span class="fu">=</span> <span class="kw">do</span>
  a <span class="ot">&lt;-</span> context
  return a

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> return ()</code></pre></div>
<pre><code>• Couldn't match type ‘extensible-effects-1.11.0.4:Data.OpenUnion.Internal.OpenUnion2.Member'
                         (Exc String) Void’
                 with ‘'True’
    arising from a use of ‘context’
• In a stmt of a 'do' block: a &lt;- context
  In the expression:
    do { a &lt;- context;
         return a }
  In an equation for ‘realContext’:
      realContext
        = do { a &lt;- context;
               return a }</code></pre>
<hr />
<p>…</p>
<hr />
<p>絵里「もー、のぞみぃ、私さっきから全然わかんないわよー！」ﾌﾟﾝｽｺ<br />
希「ごめんやでエリチw　ほらにこっちも、そのコンパイルエラーは後で解決してあげるし、ケーキ食べよ♪」<br />
にこ「わーい、ケーキだー！　ぷりぷりのいちごが、可愛いニコニーにお似合いねー♡　なんてー♡♡♡」<br />
希「いやそれはどうなん……」<br />
絵里「にこは、今日も今日とて飛ばしまくりねっ♪」ﾆｺｯﾖｼﾖｼ<br />
にこ「ぬぅわによその反応は〜〜！！」ﾜｱｧｧﾜｱｧｧﾜｱｧｧ..</p>
<h1 id="参考にした資料やで">参考にした資料やで♪</h1>
<ul>
<li><a href="https://www.stackage.org/lts-8.11/package/extensible-effects-1.11.0.4">extensible-effects - stackage</a></li>
</ul>

<hr />
<hr />

<p class="about-pr">
この記事はこちらから修正リクエストを送ることができます。 <br />
<a href="https://github.com/aiya000/aiya000.github.io/blob/src/posts/2017-07-22-learn-haskell-with-muse-extra-for-nico-birthday.md">にこ、希と一緒に学ぶHaskell（番外）「extensible-effectsの基本作用」 +絵里 - github</a> <br />
ゴミ箱ボタンの左にある、鉛筆ボタンを押してね！
</p>

<script src="../js/facebook-sdk-2.8.js"></script>

        </div>

        <div id="footer">
            (*^o^) { This blog powerd by Haskell <a href="http://jaspervdj.be/hakyll">Hakyll</a> <br />
            and Uses <a href="http://nkmr6194.github.io/Umi/">Umi</a>
        </div>
    </body>
</html>
